---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
	return [
		{ params: { collection: 'workout-logs' } },
		{ params: { collection: 'benchmarks' } },
		{ params: { collection: 'plans' } },
		{ params: { collection: 'shared-workouts' } },
		{ params: { collection: 'templates' } },
	];
}

const { collection } = Astro.params;
const content = await getCollection(collection as any);

// Enhanced sorting function that extracts dates from filenames if not in frontmatter
const sortedContent = content.sort((a: any, b: any) => {
	// First try to get dates from frontmatter
	let dateA = a.data.date;
	let dateB = b.data.date;
	
	// If no frontmatter date, try to extract from filename (YYYY-MM-DD format)
	if (!dateA && a.slug) {
		const dateMatch = a.slug.match(/^(\d{4}-\d{2}-\d{2})/);
		if (dateMatch) {
			dateA = new Date(dateMatch[1]);
		}
	}
	
	if (!dateB && b.slug) {
		const dateMatch = b.slug.match(/^(\d{4}-\d{2}-\d{2})/);
		if (dateMatch) {
			dateB = new Date(dateMatch[1]);
		}
	}
	
	// Sort by date if available (most recent first), otherwise by title
	if (dateA && dateB) {
		return new Date(dateB).getTime() - new Date(dateA).getTime();
	}
	
	// If only one has a date, prioritize it
	if (dateA && !dateB) return -1;
	if (!dateA && dateB) return 1;
	
	// Fallback to alphabetical sorting
	return a.data.title?.localeCompare(b.data.title || '') || a.slug.localeCompare(b.slug);
});

const collectionTitle = collection?.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) || '';
---

<Layout title={`${collectionTitle} - Copilot Workouts`}>
	<div class="space-y-12 px-4 md:px-8">
		<!-- Header -->
		<header class="text-center py-12">
			<h1 class="text-5xl md:text-6xl font-bold mb-6 leading-tight collection-title">
				{collectionTitle}
			</h1>
			<p class="text-xl md:text-2xl collection-subtitle">
				{sortedContent.length} {sortedContent.length === 1 ? 'item' : 'items'}
			</p>
		</header>

		<!-- Navigation -->
		<nav class="flex justify-center">
			<a 
				href="/"
				class="font-medium transition-colors hover:underline collection-link text-lg"
			>
				← Back to Home
			</a>
		</nav>

		<!-- Content Grid -->
		<section class="grid gap-8">
			{sortedContent.map((item: any) => (
				<article class="card p-8">
					<div class="space-y-6">
						<h2 class="text-3xl font-semibold leading-tight">
							<a 
								href={`/${collection}/${item.slug}`}
								class="transition-colors hover:underline collection-item-title"
							>
								{item.data.title || item.slug.replace(/-/g, ' ')}
							</a>
						</h2>
						
						<div class="flex items-center space-x-6 text-base collection-meta">
							{item.data.date && (
								<time datetime={item.data.date.toISOString()}>
									{item.data.date.toLocaleDateString('en-US', { 
										year: 'numeric', 
										month: 'long', 
										day: 'numeric' 
									})}
								</time>
							)}
							{item.data.tags && (
								<div class="flex space-x-3">
									{item.data.tags.map((tag: string) => (
										<span class="badge">
											{tag}
										</span>
									))}
								</div>
							)}
						</div>
						
						{item.body && (
							<p class="leading-relaxed text-lg collection-excerpt">
								{item.body.slice(0, 300)}...
							</p>
						)}
						
						<a 
							href={`/${collection}/${item.slug}`}
							class="inline-block font-medium transition-colors hover:underline collection-read-more text-lg"
						>
							Read more →
						</a>
					</div>
				</article>
			))}
		</section>
	</div>
</Layout>

<style>
	.collection-title {
		color: var(--color-text) !important;
	}
	
	.collection-subtitle {
		color: var(--color-text-secondary) !important;
	}
	
	.collection-link {
		color: var(--color-accent) !important;
	}
	
	.collection-item-title {
		color: var(--color-text) !important;
	}
	
	.collection-meta {
		color: var(--color-text-secondary) !important;
	}
	
	.collection-excerpt {
		color: var(--color-text-secondary) !important;
	}
	
	.collection-read-more {
		color: var(--color-accent) !important;
	}
</style>